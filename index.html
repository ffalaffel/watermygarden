<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Should I Water My Garden?</title>
    <style>
        /* ------ GLOBAL STYLES -------- */
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            max-width: 850px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(180deg, #f3faf7 0%, #e8f3ef 100%);
            line-height: 1.6;
            color: #2b3a33;
        }

        h1 {
            color: #2a6f97;
            text-align: center;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        h1::before { content: "üå± "; }

        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            background: #2a6f97;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: transform 0.1s ease, background 0.2s ease;
        }

        button:hover {
            background: #245b7d;
            transform: translateY(-2px);
        }

        /* ------- SECTION CARDS -------- */
        .section {
            padding: 24px;
            margin-bottom: 30px;
            border-radius: 12px;
            background: #ffffffcc;
            backdrop-filter: blur(4px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .section-input { background: #e9f5f0; border: 1px solid #c7ddd5; }

        #suggestions div { padding: 8px; cursor: pointer; }
        #suggestions div:hover { background: #eef; }

        /* ------- TIMELINE ------ */
        .timeline-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            gap: 8px;
            padding-bottom: 10px;
        }

        .timeline-box {
            width: 100px;
            height: 150px;
            background: #ffffff;
            border: 1px solid #d0d0d0;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10px 4px;
            box-sizing: border-box;
        }

        .timeline-today {
            border: 2px solid #2a6f97;
            background: #f0f7ff;
            box-shadow: 0 4px 12px rgba(42, 111, 151, 0.2);
        }

        .tile-top { font-size: 24px; }
        .tile-mid { text-align: center; min-height: 65px; display: flex; flex-direction: column; justify-content: center; }
        .tile-bottom { font-size: 10px; color: #777; font-weight: bold; text-transform: uppercase; border-top: 1px solid #f0f0f0; width: 80%; padding-top: 4px; text-align: center; }
        .timeline-temp { font-size: 12px; font-weight: bold; }
        .temp-max { color: #c62828; }
        .temp-min { color: #2a6f97; }

        .rain-badge { font-size: 10px; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 12px; margin-top: 4px; font-weight: bold; }
        .rain-empty { height: 19px; }

        /* ---------- RESULT --------- */
        #result { margin-top: 20px; font-size: 1.5em; text-align: center; }
        .yes { color: #2e7d32; font-weight: bold; }
        .no { color: #855e00; font-weight: bold; }

        /* -------- ACCORDIONS ---------- */
        .accordion {
            background-color: #e6e6e6;
            color: #333;
            cursor: pointer;
            padding: 14px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 17px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .accordion:after { content: '+'; float: right; font-weight: bold; }
        .accordion.active:after { content: '-'; }

        .panel { padding: 0 15px; background-color: #ffffff; display: none; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }

        /* ---------- COFFEE SECTION ---------- */
        #supportSection { display: none; opacity: 0; transition: opacity 0.8s ease; }

        .support-card {
            background: #fff;
            border: 2px dashed #b87333;
            border-radius: 15px;
            padding: 20px;
            margin: 30px auto;
            text-align: center;
            max-width: 420px;
        }

        .coffee-btn {
            display: inline-block;
            background: linear-gradient(135deg, #b87333 0%, #8b4513 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .coffee-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .coffee-text {
            font-size: 0.95em;
            color: #5d4037;
            margin-bottom: 15px;
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <h1>Should I Water My Garden?</h1>

    <div class="section section-input">
        <p><strong>Enter your city or town:</strong></p>
        <div style="position: relative; width: 90%; margin: 0 auto;">
            <input id="cityInput" type="text" placeholder="e.g., Sherbrooke" oninput="fetchSuggestions()" 
                   style="padding:12px; width:100%; border-radius:8px; border:1px solid #bbb; box-sizing: border-box;">
            <div id="suggestions" style="position:absolute; top:46px; left:0; background:white; border:1px solid #ccc; width:100%; max-height:150px; overflow-y:auto; display:none; z-index:100;"></div>
        </div>
        <div id="locationStatus" style="margin-top:15px; font-weight:bold; text-align:center; color:#2a6f97;"></div>
        
        <hr style="margin:25px 0; border:0; border-top:1px solid #c7ddd5;">
        
        <p><strong>When did you last water?</strong></p>
        <div style="text-align:center;">
            <button onclick="checkWater(0)">Today</button>
            <button onclick="checkWater(1)">Yesterday</button>
            <button onclick="checkWater(2)">2 Days Ago</button>
            <button onclick="checkWater(3)">Earlier</button>
        </div>
    </div>

    <div class="section">
        <div id="result"></div>
        <div id="timeline"></div>
    </div>

    <div id="supportSection">
        <div class="support-card">
            <div class="coffee-text">Did your tomatoes make it? The garden needs water, but the developer needs caffeine. Don't let us both shrivel up!</div>
            <a class="coffee-btn" href="https://ko-fi.com/ffalaffel" target="_blank">‚òï Buy me a coffee!</a>
        </div>
    </div>

    <button class="accordion">Show detailed breakdown</button>
    <div class="panel">
        <div id="breakdown" style="padding: 15px 0;">Please run a check to see the data.</div>
    </div>

    <button class="accordion">About this project</button>
    <div class="panel">
        <div style="padding: 15px 0;">
            This tool was born out of pure laziness. I kept forgetting to check the weather, telling myself the garden would "figure it all out" and eventually watched all my tomatoes shrivel into tragic raisin‚Äëtomatoes. Now the app does the thinking for me and my tomatoes can die via squirrel instead.
        </div>
    </div>

    <button class="accordion">More info</button>
    <div class="panel">
        <div style="padding: 15px 0;">
            <p><strong>The Moisture Balance Logic:</strong> We treat your soil like a bank account. 
            <ul>
                <li><strong>Deposits:</strong> A manual watering event is a 15mm deposit. Rain is added based on the total millimeters fallen or forecast.</li>
                <li><strong>Withdrawals (Evapotranspiration):</strong> We calculate water loss based on daily heat and sunshine. 
                    <ul>
                        <li>Sunny days >30¬∞C: -10mm</li>
                        <li>Sunny days >25¬∞C: -5mm</li>
                        <li>Cloudy warm days (>20¬∞C) : -3mm to -6mm</li>
                        <li>Mild days (<20¬∞C): -2mm baseline loss</li>
                    </ul>
                </li>
            </ul>
            We recommend watering if the 6-day balance drops below 10mm.</p>
            <p><strong>Data Source:</strong> Weather data is provided by <a href="https://open-meteo.com/" target="_blank" style="color: #2a6f97;">Open-Meteo</a>.</p>
<p><strong>Disclaimer:</strong> This is just a silly tool, use your own judgement when caring for your plants.</p>
        </div>
    </div>

    <script>
        let userLat = localStorage.getItem('lat'), userLon = localStorage.getItem('lon'), cityName = localStorage.getItem('city');

        if (cityName) {
            document.getElementById("locationStatus").textContent = `Stored location: ${cityName}`;
            document.getElementById("cityInput").value = cityName;
        }

        async function fetchSuggestions() {
            const query = document.getElementById("cityInput").value.trim();
            const suggestionsBox = document.getElementById("suggestions");
            if (query.length < 2) { suggestionsBox.style.display = "none"; return; }
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5`);
            const data = await res.json();
            if (!data.results) return;
            suggestionsBox.innerHTML = data.results.map(p => 
                `<div style="padding:8px; cursor:pointer;" onclick="setLoc(${p.latitude}, ${p.longitude}, '${p.name}')">${p.name}, ${p.country}</div>`
            ).join('');
            suggestionsBox.style.display = "block";
        }

        function setLoc(lat, lon, name) {
            userLat = lat; userLon = lon;
            localStorage.setItem('lat', lat); localStorage.setItem('lon', lon); localStorage.setItem('city', name);
            document.getElementById("locationStatus").textContent = `Location set: ${name}`;
            document.getElementById("suggestions").style.display = "none";
            document.getElementById("cityInput").value = name;
        }

        function getIcon(rain, sun, rainProb) {
            if (rain > 5) return "üåßÔ∏è";
            if (rainProb > 50) return "üå¶Ô∏è";
            if (sun > 14400) return "‚òÄÔ∏è";
            if (sun > 3600) return "‚õÖ";
            return "‚òÅÔ∏è";
        }

        function renderTimeline(data) {
            const timelineDiv = document.getElementById("timeline");
            timelineDiv.innerHTML = "<p><strong>7‚ÄëDay Outlook:</strong></p>";
            const container = document.createElement("div");
            container.className = "timeline-container";
            for (let i = 0; i < 7; i++) {
                const rain = data.daily.precipitation_sum[i];
                const rainProb = data.daily.precipitation_probability_max[i];
                const sun = data.daily.sunshine_duration[i];
                const maxT = Math.round(data.daily.temperature_2m_max[i]);
                const minT = Math.round(data.daily.temperature_2m_min[i]);
                const box = document.createElement("div");
                box.className = `timeline-box ${i === 3 ? 'timeline-today' : ''}`;
                const label = i === 3 ? "Today" : (i < 3 ? `${3 - i}d ago` : `+${i - 3}d`);
                let warnings = "";
                if (maxT >= 28) warnings += `<span title="Heat Stress">üå°Ô∏è</span>`;
                if (minT <= 5) warnings += `<span title="Frost Risk">üßä</span>`;
                const rainDisplay = rain > 0 ? `<div class="rain-badge">üíß ${rain.toFixed(1)}mm</div>` : `<div class="rain-empty"></div>`;
                box.innerHTML = `<div class="tile-top">${getIcon(rain, sun, rainProb)}</div><div class="tile-mid"><div class="timeline-temp"><span class="temp-max">${maxT}¬∞</span> / <span class="temp-min">${minT}¬∞</span>${warnings}</div>${rainDisplay}</div><div class="tile-bottom">${label}</div>`;
                container.appendChild(box);
            }
            timelineDiv.appendChild(container);
        }

        async function checkWater(lastWateredDays) {
            const resDiv = document.getElementById("result");
            const breakDiv = document.getElementById("breakdown");
            const coffeeSec = document.getElementById("supportSection");
            
            if (!userLat) { resDiv.textContent = "Please select a city first!"; return; }
            resDiv.textContent = "Checking the soil balance...";
            
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&daily=precipitation_sum,precipitation_probability_max,temperature_2m_max,temperature_2m_min,sunshine_duration&past_days=3&forecast_days=4`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                renderTimeline(data);

                const pastRain = data.daily.precipitation_sum.slice(0, 3).reduce((a, b) => a + b, 0);
                const futureRain = data.daily.precipitation_sum.slice(3, 7).reduce((a, b) => a + b, 0);
                let evapLoss = 0;
                let isVeryHot = false;
                for(let i=0; i<6; i++) {
                    let temp = data.daily.temperature_2m_max[i];
                    let sun = data.daily.sunshine_duration[i];
                    if (temp >= 30) { evapLoss += (sun > 14400 ? 10 : 6); isVeryHot = true; }
                    else if (temp >= 25) { evapLoss += (sun > 14400 ? 5 : 3); isVeryHot = true; }
                    else if (temp >= 20) evapLoss += 2;
                }

                // FIXED: Manual watering always counts as a 15mm event
                let waterEventCredit = (lastWateredDays <= 2) ? 15 : 0;
                const waterBalance = (waterEventCredit + pastRain + futureRain) - evapLoss;
                
                const absoluteMin = Math.min(...data.daily.temperature_2m_min);
                const nextMin = Math.min(...data.daily.temperature_2m_min.slice(3, 6));

                let decision = (waterBalance < 10);
                if (lastWateredDays === 0) decision = false;

                resDiv.innerHTML = decision ? `<strong class="yes">Yes, your garden likely needs water soon.</strong>` : `<strong class="no">No, your garden should be fine for now.</strong>`;
                
                if (absoluteMin <= -5) {
                    resDiv.innerHTML += `<div style="font-size: 0.6em; margin-top: 10px; color: #2a6f97;">‚ùÑÔ∏è Wait, are you growing icicles? It's getting cold out there!</div>`;
                } else if (nextMin <= 5) {
                    resDiv.innerHTML += `<div style="font-size: 0.6em; margin-top: 10px; color: #2a6f97;">üßä Frost risk! Be careful with tender plants.</div>`;
                }

                breakDiv.innerHTML = `
                    <ul style="list-style-type: none; padding: 0;">
                        <li>‚Ä¢ Your garden got <strong>${(pastRain + waterEventCredit).toFixed(1)}mm</strong> of water recently (${pastRain.toFixed(1)}mm rain, ${waterEventCredit}mm manual watering).</li>
                        <li>‚Ä¢ Rain <strong>${futureRain > 2 ? "is expected" : "is not really expected"}</strong> in the next couple days (${futureRain.toFixed(1)}mm forecast).</li>
                        <li>‚Ä¢ Temperatures <strong>${isVeryHot ? "will be hot and sunny" : "look fairly mild"}</strong>, impacting evaporation.</li>
                        <br>
                        <li><strong>THEREFORE</strong>, your garden ${decision ? "would probably benefit from a nice watering today." : "should be fine without extra water today."}</li>
                    </ul>
                `;

                coffeeSec.style.display = "block";
                setTimeout(() => { coffeeSec.style.opacity = "1"; }, 100);

            } catch (e) { resDiv.textContent = "Error fetching data."; }
        }

        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("accordion")) {
                e.target.classList.toggle("active");
                const panel = e.target.nextElementSibling;
                panel.style.display = (panel.style.display === "block") ? "none" : "block";
            }
        });
    </script>
</body>
</html>


